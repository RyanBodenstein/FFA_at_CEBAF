! corrector_test1.lat
! File containing base element definitions
! West Arc hardware, 1 BPM and 1 corrector per cell

call, file = 2022-12-16_params_west.bmad

! Element Definitions -------------------------------------------------------------------
 


! Bending Defocusing unit
! Patches ----------------
pr_bd: patch, x_pitch = 0.5*angbd                                           
! Magnet Sections --------                                           
bda: sbend, field_master = T, b1_gradient = GD, l = BDL/6, 
    db_field = BD_fld, x_offset = dxDA,
    x1_limit = .03, x2_limit = .02, y_limit = 0.008!, offset_moves_aperture = T                   
bdb: sbend, field_master = T, b1_gradient = GD, l = BDL/6, 
    db_field = BD_fld, x_offset = dxDB,
    x1_limit = .03, x2_limit = .02, y_limit = 0.008!, offset_moves_aperture = T              
bdc: sbend, field_master = T, b1_gradient = GD, l = BDL/6, 
    db_field = BD_fld, x_offset = dxDC,
    x1_limit = .03, x2_limit = .02, y_limit = 0.008!, offset_moves_aperture = T 
  
bdb_short: sbend, field_master = T, b1_gradient = GD, l = BDL/3-0.2, 
    db_field = BD_fld, x_offset = bdb[x_offset],
    x1_limit = .03, x2_limit = .02, y_limit = 0.008!, offset_moves_aperture = T            


pqbdb: sbend, field_master = T, l = 0.2-BDL/6, x_offset = bdb[x_offset], 
    x1_limit = .03, x2_limit = .02, y_limit = 0.008!, offset_moves_aperture = T 
pqbdc: sbend, field_master = T, l = BDL/6, x_offset = bdc[x_offset], 
    x1_limit = .0, x2_limit = .02, y_limit = 0.008!, offset_moves_aperture = T 
! Whole Magnet ----------
BDM : line = (pr_bd, bda, bdb_short, pqbdb, pqbdc, pqbdc, pqbdb, bdb_short, bda, pr_bd)



! Drifts -------------------------------------------------
d2: drift                ! mid-cell drift
d2i: drift               ! half drift for cell start
d2o: drift               ! half drift for cellend
! --------------------------------------------------------                          


! Bending Focusing unit
! Patches ----------------
pr_bf: patch, x_pitch = 0.5*angbf                                            
! Magnet Sections --------                                             
bfa: sbend, field_master =T, b1_gradient = GF, l = BFL/6, 
    db_field = BF_fld, x_offset = dxFA,
    x1_limit = .03, x2_limit = .03, y_limit = 0.008!, offset_moves_aperture = T                                              
bfb: sbend, field_master =T, b1_gradient = GF, l = BFL/6, 
    db_field = BF_fld, x_offset = dxFB,
    x1_limit = .03, x2_limit = .03, y_limit = 0.008!, offset_moves_aperture = T                                            
bfc: sbend, field_master =T, b1_gradient = GF, l = BFL/6, 
    db_field = BF_fld, x_offset = dxFC,
    x1_limit = .03, x2_limit = .03, y_limit = 0.008!, offset_moves_aperture = T

                                                
bfc_short: sbend, field_master =T, b1_gradient = GF, l = BFL/6-0.2, 
    db_field = BF_fld, x_offset = dxFC,
    x1_limit = .03, x2_limit = .03, y_limit = 0.008!, offset_moves_aperture = T


pqbfc: sbend, field_master = T, l = 0.2, x_offset = bfc_short[x_offset], 
    x1_limit = .03, x2_limit = .03, y_limit = 0.008!, offset_moves_aperture = T

! Whole Magnet ----------
! BFM : line = (pr_bf, bfa, bfb, bfc_short, pqbfc, pqbfc, bfc_short, bfb, bfa, pr_bf) ! with corrector
BFM : line = (pr_bf, bfa, bfb, bfc, bfc, bfb, bfa, pr_bf)


! Control Elements ---------------------------------------

! Girders -----------------------
BFMG : Girder = {BFM}, origin_ele = global_coordinates      ! Bending focusing girder
BDMG : GIRDER = {BDM}, origin_ele = global_coordinates      ! Bending defocusing girder
! -------------------------------

! Overlays ----------------------
! The following overlay preserves the overrall 
! size of each cell regardless of offsets
CREG : Overlay = {d2i[l]:(DL/2 + zo1), BDMG[z_offset]: zo1, d2[l]:(DL - zo1 + zo2), 
                      BFMG[z_offset]: zo2, d2o[l]:(DL/2 - zo2)}, 
                      VAR = {zo1, zo2}, zo1 = 0, zo2 = 0, GANG = False

! correctors
Corr: Overlay = {pqbdc[db_field]: BD_fld + hk, pqbdc[bl_vkick]: vk, pqbdc[b1_gradient]: GD + gc,
                 pqbdb[db_field]: bdb_short[db_field] + hk, pqbdb[bl_vkick]: vk, pqbdb[b1_gradient]: bdb_short[b1_gradient] + gc},
!                 pqbfc[db_field]: bfc_short[db_field] + hk, pqbfc[bl_vkick]: vk, pqbfc[b1_gradient]: bfc_short[b1_gradient] + gc},
        var = {hk, vk, gc}, hk=0, vk=0, gc=0,
        GANG = False
! --------------------------------------------------------



! markers for diagnostic purposes
! -------------------------------
MK.BEG: marker      ! beginning of the lattice
MK.BPM1: marker, type = "BPM"    
! MK.BPM2: marker, type = "BPM"             
MK.END: marker      ! end of the lattice
! -------------------------------
!mk.bpm2: marker, superimpose, ref = d2, ref_origin = , ele_origin = cente


! Lattice Definition --------------------------------------------------------------------


cell: line = (MK.BPM1, d2i, BDM, d2,
              BFM, d2o)

arc1: line = (MK.BEG, cell, MK.END)

cell5: line = (cell, cell, cell, cell, cell)

arc5: line = (MK.BEG, cell5, MK.END)

cell10: line = (cell5, cell5)

arc10: line = (MK.BEG, cell10, MK.END)

cell20: line = (cell10, cell10)

arc75: line = (MK.BEG, cell20, cell20, cell20, cell10, cell5, MK.END)


use, arc10